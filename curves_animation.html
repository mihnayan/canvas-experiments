<!DOCTYPE html>
<html>
<head>
    <title>Mihnayan experiments with Canvas</title>
</head>
<body>
    <canvas id="cnv" width="1024" height="768"></canvas>
    <script type="text/javascript" src="mihnayan.graphic.js"></script>
    <script type="text/javascript" src="figures.js"></script>
    <script type="text/javascript">
        var settings = {
            maxNumberOfLegs: 4,
            maxLegRPM: 0.5,
            minLegRPM: 0.25
        }
    </script>
    <script type="text/javascript">
        window.onload = function () {
            var ctx = document.getElementById("cnv").getContext("2d");
            graphics.init({
                canvasContext: ctx, 
                backgroundColor: '#000'
            });

            var getRandomLegRevolutionTime = function () {
                var rpm = Math.random() * (settings.maxLegRPM - settings.minLegRPM) + settings.minLegRPM;
                return 1000 / rpm;
            }

            var am = graphics.animator(0,0, 400,400);
            var eventManager = graphics.getEventManager();

            var currentNumberOfLegs = 0;
            var createLegRotation = function () {
                if (currentNumberOfLegs >= settings.maxNumberOfLegs) return;
                var newLeg = graphics.copyFigure(leg);
                var legRotateMotion = am.getRotateMotion(newLeg, 210, 150, -360*10, 10*getRandomLegRevolutionTime());
                am.addMotion(legRotateMotion);
                legRotateMotion.start();
                legRotateMotion.onEnd = function (motion) {
                    motion.repeat();
                }
                legRotateMotion.start();
                currentNumberOfLegs++;
            };

            var fishToMouth = function () {
                var fishTransformMotion = am.getTransformMotion(fish, mouth, 3000);
                var fishMotionId = am.addMotion(fishTransformMotion);
                fishTransformMotion.pause();
                fishTransformMotion.start();
                var fishId = eventManager.addObservedFigure(fish);
                eventManager.addFigureEvent(fishId, 'mousemove', function () {
                    fishTransformMotion.resume();
                });

                var eyeballId = eventManager.addObservedFigure(eyeball);
                eventManager.addFigureEvent(eyeballId, 'click', function () {
                    createLegRotation();
                });

                fishTransformMotion.onEnd = function (motion) {
                    eventManager.deleteObservedFigure(eyeballId);
                    eventManager.deleteObservedFigure(fishId);
                    am.deleteMotion(fishMotionId);
                    mouthToFish();
                }
            };

            var mouthToFish = function () {
                var mouthTransformMotion = am.getTransformMotion(mouth, fish, 3000);
                var mouthMotionId = am.addMotion(mouthTransformMotion);
                mouthTransformMotion.pause();
                mouthTransformMotion.start();
                var mouthId = eventManager.addObservedFigure(mouth);
                eventManager.addFigureEvent(mouthId, 'mousemove', function () {
                    mouthTransformMotion.resume();
                });

                var eyeballId = eventManager.addObservedFigure(eyeball);
                eventManager.addFigureEvent(eyeballId, 'click', function () {
                    createLegRotation();
                });

                mouthTransformMotion.onEnd = function (motion) {
                    eventManager.deleteObservedFigure(eyeballId);
                    eventManager.deleteObservedFigure(mouthId);
                    am.deleteMotion(mouthMotionId);
                    fishToMouth();
                }
            };

            var eyeballStatic = am.getStaticMotion(eyeball);
            am.addMotion(eyeballStatic);

            fishToMouth();
            createLegRotation();

            am.start();
        }
    </script>
</body>
</html>